<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API –û—á–∏—Å—Ç–∫–∏ –ß–∞—Ç–∞ - Electric Group</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c5364;
            border-bottom: 2px solid #2c5364;
            padding-bottom: 10px;
        }
        .status {
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            display: none;
        }
        .success { background: #d4edda; color: #155724; display: block; }
        .error { background: #f8d7da; color: #721c24; display: block; }
        .info { background: #d1ecf1; color: #0c5460; display: block; }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
        }
        .url-box {
            background: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßπ API –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ —á–∞—Ç–∞</h1>
        
        <div class="status info" id="status">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
        
        <div id="result"></div>
        
        <h2>üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è cron-job.org:</h2>
        <div class="url-box">
            <strong>URL –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:</strong><br>
            <code id="apiUrl">https://alivu.github.io/Electric_Group/cleanup-api.html?key=–í–ê–®_–ö–õ–Æ–ß</code>
        </div>
        
        <h3>üîß –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:</h3>
        <ul>
            <li><strong>key</strong> - —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</li>
            <li><strong>limit</strong> - —Å–∫–æ–ª—å–∫–æ –æ—Å—Ç–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 0)</li>
            <li><strong>dry_run</strong> - —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ –±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è (true/false)</li>
        </ul>
        
        <h3>üìä –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤:</h3>
        <pre>
// –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
https://alivu.github.io/Electric_Group/cleanup-api.html?key=electric2024

// –û—Å—Ç–∞–≤–∏—Ç—å 50 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
https://alivu.github.io/Electric_Group/cleanup-api.html?key=electric2024&limit=50

// –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ (–±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è)
https://alivu.github.io/Electric_Group/cleanup-api.html?key=electric2024&dry_run=true
        </pre>
        
        <h3>‚úÖ –û—Ç–≤–µ—Ç API:</h3>
        <pre id="responseExample">
{
    "success": true,
    "deleted": 125,
    "kept": 50,
    "total_before": 175,
    "total_after": 50,
    "timestamp": "2024-01-24T04:00:00.000Z",
    "message": "–ß–∞—Ç –æ—á–∏—â–µ–Ω —É—Å–ø–µ—à–Ω–æ"
}
        </pre>
    </div>

    <script>
    // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
    const CONFIG = {
        // üîí –ò–ó–ú–ï–ù–ò–¢–ï –≠–¢–û–¢ –ö–õ–Æ–ß –Ω–∞ —Å–≤–æ–π —Å–ª–æ–∂–Ω—ã–π!
        SECRET_KEY: 'electric2024',
        
        // –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–æ–º–Ω–∞—Ç—ã —á–∞—Ç–∞
        ROOM_ID: 'main-electricians-room',
        
        // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ—Å—Ç–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π (0 = —É–¥–∞–ª–∏—Ç—å –≤—Å–µ)
        DEFAULT_KEEP: 0,
        
        // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∑–∞ —Ä–∞–∑
        MAX_BATCH_SIZE: 400
    };
    
    // ========== –≠–õ–ï–ú–ï–ù–¢–´ DOM ==========
    const statusEl = document.getElementById('status');
    const resultEl = document.getElementById('result');
    const apiUrlEl = document.getElementById('apiUrl');
    const responseExampleEl = document.getElementById('responseExample');
    
    // ========== –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ==========
    async function initializeAndClean() {
        try {
            // 1. –ü–∞—Ä—Å–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã URL
            const urlParams = new URLSearchParams(window.location.search);
            const key = urlParams.get('key');
            const keepLimit = parseInt(urlParams.get('limit')) || CONFIG.DEFAULT_KEEP;
            const dryRun = urlParams.get('dry_run') === 'true';
            
            // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª—é—á
            updateStatus('üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–∞...', 'info');
            
            if (key !== CONFIG.SECRET_KEY) {
                throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á');
            }
            
            // 3. –û–±–Ω–æ–≤–ª—è–µ–º URL –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
            apiUrlEl.textContent = `${window.location.origin}${window.location.pathname}?key=${CONFIG.SECRET_KEY}`;
            
            // 4. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Firebase
            updateStatus('üî• –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase...', 'info');
            
            const firebaseConfig = {
                apiKey: "AIzaSyCRJh0fFbJAc6dFz1O21SbjyAaPbMV58xc",
                authDomain: "electrician-chat.firebaseapp.com",
                projectId: "electrician-chat",
                storageBucket: "electrician-chat.firebasestorage.app",
                messagingSenderId: "1005885507362",
                appId: "1:1005885507362:web:c030a98505761b0add877b"
            };
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –ª–∏ —É–∂–µ Firebase
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            
            // 5. –ê–≤—Ç–æ—Ä–∏–∑—É–µ–º—Å—è –∞–Ω–æ–Ω–∏–º–Ω–æ
            updateStatus('üë§ –ê–Ω–æ–Ω–∏–º–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è...', 'info');
            
            await firebase.auth().signInAnonymously();
            
            // 6. –í—ã–ø–æ–ª–Ω—è–µ–º –æ—á–∏—Å—Ç–∫—É
            const result = await cleanChat(keepLimit, dryRun);
            
            // 7. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            showResult(result);
            
        } catch (error) {
            showError(error);
        }
    }
    
    // ========== –§–£–ù–ö–¶–ò–Ø –û–ß–ò–°–¢–ö–ò –ß–ê–¢–ê ==========
    async function cleanChat(keepLimit = 0, dryRun = false) {
        updateStatus('üìä –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π...', 'info');
        
        const db = firebase.firestore();
        const messagesRef = db.collection('rooms').doc(CONFIG.ROOM_ID).collection('messages');
        
        // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
        const snapshot = await messagesRef
            .orderBy('timestamp', 'desc')
            .get();
        
        const totalBefore = snapshot.size;
        
        // –ï—Å–ª–∏ –æ—Å—Ç–∞–≤–ª—è–µ–º 0 —Å–æ–æ–±—â–µ–Ω–∏–π –∏–ª–∏ –º–µ–Ω—å—à–µ —á–µ–º –µ—Å—Ç—å - —É–¥–∞–ª—è–µ–º –≤—Å–µ
        const messagesToKeep = Math.min(keepLimit, totalBefore);
        const messagesToDelete = totalBefore - messagesToKeep;
        
        updateStatus(`üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: ${totalBefore} –≤—Å–µ–≥–æ, —É–¥–∞–ª—è–µ–º ${messagesToDelete}, –æ—Å—Ç–∞–≤–ª—è–µ–º ${messagesToKeep}`, 'info');
        
        if (dryRun) {
            updateStatus('üß™ –¢–ï–°–¢–û–í–´–ô –†–ï–ñ–ò–ú: —É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è', 'info');
            return {
                success: true,
                deleted: 0,
                kept: messagesToKeep,
                total_before: totalBefore,
                total_after: messagesToKeep,
                dry_run: true,
                message: '–¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ —É—Å–ø–µ—à–µ–Ω'
            };
        }
        
        if (messagesToDelete <= 0) {
            updateStatus('‚úÖ –ù–µ—á–µ–≥–æ —É–¥–∞–ª—è—Ç—å', 'success');
            return {
                success: true,
                deleted: 0,
                kept: messagesToKeep,
                total_before: totalBefore,
                total_after: messagesToKeep,
                message: '–ù–µ—á–µ–≥–æ —É–¥–∞–ª—è—Ç—å'
            };
        }
        
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–∫—Ä–æ–º–µ —Ç–µ—Ö, —á—Ç–æ –æ—Å—Ç–∞–≤–ª—è–µ–º)
        updateStatus(`üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ ${messagesToDelete} —Å–æ–æ–±—â–µ–Ω–∏–π...`, 'info');
        
        let deletedCount = 0;
        const messagesToRemove = snapshot.docs.slice(messagesToKeep);
        
        // –£–¥–∞–ª—è–µ–º –ø–∞–∫–µ—Ç–∞–º–∏
        for (let i = 0; i < messagesToRemove.length; i += CONFIG.MAX_BATCH_SIZE) {
            const batch = db.batch();
            const chunk = messagesToRemove.slice(i, i + CONFIG.MAX_BATCH_SIZE);
            
            chunk.forEach(doc => {
                batch.delete(doc.ref);
            });
            
            await batch.commit();
            deletedCount += chunk.length;
            
            updateStatus(`üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ: ${deletedCount}/${messagesToDelete}...`, 'info');
            
            // –ü–∞—É–∑–∞ –º–µ–∂–¥—É –ø–∞–∫–µ—Ç–∞–º–∏ —á—Ç–æ–±—ã –Ω–µ –ø—Ä–µ–≤—ã—Å–∏—Ç—å –ª–∏–º–∏—Ç—ã
            if (i + CONFIG.MAX_BATCH_SIZE < messagesToRemove.length) {
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ —É–¥–∞–ª–∏–ª–∏
        if (deletedCount > 0) {
            await messagesRef.add({
                text: `üßπ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞: —É–¥–∞–ª–µ–Ω–æ ${deletedCount} —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.`,
                userId: 'system-auto-clean',
                userName: '–°–∏—Å—Ç–µ–º–∞',
                userEmail: 'system@electric-group.com',
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                isSystem: true,
                isElectrician: true
            });
        }
        
        updateStatus('‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!', 'success');
        
        return {
            success: true,
            deleted: deletedCount,
            kept: messagesToKeep,
            total_before: totalBefore,
            total_after: messagesToKeep,
            timestamp: new Date().toISOString(),
            message: `–£–¥–∞–ª–µ–Ω–æ ${deletedCount} —Å–æ–æ–±—â–µ–Ω–∏–π, –æ—Å—Ç–∞–≤–ª–µ–Ω–æ ${messagesToKeep}`
        };
    }
    
    // ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
    function updateStatus(message, type = 'info') {
        statusEl.textContent = message;
        statusEl.className = 'status ' + type;
        console.log(`[${type.toUpperCase()}] ${message}`);
    }
    
    function showResult(data) {
        resultEl.innerHTML = `
            <div class="status success">
                <h3>‚úÖ ${data.message}</h3>
                <p><strong>–£–¥–∞–ª–µ–Ω–æ:</strong> ${data.deleted} —Å–æ–æ–±—â–µ–Ω–∏–π</p>
                <p><strong>–û—Å—Ç–∞–≤–ª–µ–Ω–æ:</strong> ${data.kept} —Å–æ–æ–±—â–µ–Ω–∏–π</p>
                <p><strong>–ë—ã–ª–æ:</strong> ${data.total_before} ‚Üí <strong>–°—Ç–∞–ª–æ:</strong> ${data.total_after}</p>
                <p><strong>–í—Ä–µ–º—è:</strong> ${new Date(data.timestamp || Date.now()).toLocaleString()}</p>
            </div>
        `;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        responseExampleEl.textContent = JSON.stringify(data, null, 2);
    }
    
    function showError(error) {
        const errorData = {
            success: false,
            error: error.message,
            timestamp: new Date().toISOString()
        };
        
        resultEl.innerHTML = `
            <div class="status error">
                <h3>‚ùå –û—à–∏–±–∫–∞</h3>
                <p><strong>–°–æ–æ–±—â–µ–Ω–∏–µ:</strong> ${error.message}</p>
                <p><strong>–í—Ä–µ–º—è:</strong> ${new Date().toLocaleString()}</p>
            </div>
        `;
        
        responseExampleEl.textContent = JSON.stringify(errorData, null, 2);
        
        console.error('–û—à–∏–±–∫–∞:', error);
    }
    
    // ========== –ó–ê–ü–£–°–ö –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï ==========
    document.addEventListener('DOMContentLoaded', () => {
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å –∫–ª—é—á –≤ URL
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('key')) {
            initializeAndClean();
        } else {
            updateStatus('üîë –î–æ–±–∞–≤—å—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä ?key=–í–ê–®_–ö–õ–Æ–ß –≤ URL', 'info');
        }
    });
    </script>
</body>
</html>
