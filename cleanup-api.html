<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API –û—á–∏—Å—Ç–∫–∏ –ß–∞—Ç–∞ - Electric Group</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c5364;
            border-bottom: 2px solid #2c5364;
            padding-bottom: 10px;
        }
        .status {
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            display: none;
        }
        .success { background: #d4edda; color: #155724; display: block; }
        .error { background: #f8d7da; color: #721c24; display: block; }
        .info { background: #d1ecf1; color: #0c5460; display: block; }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
        }
        .url-box {
            background: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßπ API –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ —á–∞—Ç–∞</h1>
        
        <div class="status info" id="status">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
        
        <div id="result"></div>
        
        <h2>üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è cron-job.org:</h2>
        <div class="url-box">
            <strong>URL –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:</strong><br>
            <code id="apiUrl">https://alivu.github.io/Electric_Group/cleanup-api.html?key=–í–ê–®_–ö–õ–Æ–ß</code>
        </div>
        
        <h3>üîß –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:</h3>
        <ul>
            <li><strong>key</strong> - —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</li>
            <li><strong>limit</strong> - —Å–∫–æ–ª—å–∫–æ –æ—Å—Ç–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 0)</li>
            <li><strong>dry_run</strong> - —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ –±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è (true/false)</li>
        </ul>
        
        <h3>üìä –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤:</h3>
        <pre>
// –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
https://alivu.github.io/Electric_Group/cleanup-api.html?key=electric2024

// –û—Å—Ç–∞–≤–∏—Ç—å 50 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
https://alivu.github.io/Electric_Group/cleanup-api.html?key=electric2024&limit=50

// –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ (–±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è)
https://alivu.github.io/Electric_Group/cleanup-api.html?key=electric2024&dry_run=true
        </pre>
        
        <h3>‚úÖ –û—Ç–≤–µ—Ç API:</h3>
        <pre id="responseExample">
{
    "success": true,
    "deleted": 125,
    "kept": 50,
    "total_before": 175,
    "total_after": 50,
    "timestamp": "2024-01-24T04:00:00.000Z",
    "message": "–ß–∞—Ç –æ—á–∏—â–µ–Ω —É—Å–ø–µ—à–Ω–æ"
}
        </pre>
    </div>

<script>
// ========== –ù–ê–°–¢–†–û–ô–ö–ò ==========
const SECRET_KEY = 'electric2024'; // –¢–≤–æ–π –∫–ª—é—á
const ROOM_ID = 'main-electricians-room';

// ========== –û–°–ù–û–í–ù–û–ô –ö–û–î ==========
async function startCleanup() {
    const url = new URL(window.location.href);
    const key = url.searchParams.get('key');
    const limit = parseInt(url.searchParams.get('limit')) || 50;
    
    // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–∞
    if (key !== SECRET_KEY) {
        document.getElementById('status').innerHTML = '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á';
        return;
    }
    
    // 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyCRJh0fFbJAc6dFz1O21SbjyAaPbMV58xc",
        authDomain: "electrician-chat.firebaseapp.com",
        projectId: "electrician-chat",
        storageBucket: "electrician-chat.firebasestorage.app",
        messagingSenderId: "1005885507362",
        appId: "1:1005885507362:web:c030a98505761b0add877b"
    };
    
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    
    // 3. –í—Ö–æ–¥ –∞–Ω–æ–Ω–∏–º–Ω–æ
    await firebase.auth().signInAnonymously();
    const db = firebase.firestore();
    
    // 4. –ü–û–ú–ï–¢–ö–ê —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–∫ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö (–í–ú–ï–°–¢–û –£–î–ê–õ–ï–ù–ò–Ø)
    const messagesRef = db.collection('rooms').doc(ROOM_ID).collection('messages');
    const snapshot = await messagesRef.orderBy('timestamp', 'desc').get();
    
    const totalMessages = snapshot.size;
    const keepCount = Math.min(limit, totalMessages);
    const markCount = totalMessages - keepCount;
    
    if (markCount <= 0) {
        document.getElementById('result').innerHTML = `
            <div style="background:#d4edda; padding:20px; border-radius:10px;">
                <h3>‚úÖ –ù–µ—á–µ–≥–æ —É–¥–∞–ª—è—Ç—å</h3>
                <p>–°–æ–æ–±—â–µ–Ω–∏–π: ${totalMessages}</p>
                <p>–û—Å—Ç–∞–≤–ª—è–µ–º: ${keepCount}</p>
            </div>
        `;
        return;
    }
    
    // –ü–æ–º–µ—á–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ deleted: true
    let marked = 0;
    const messagesToMark = snapshot.docs.slice(keepCount);
    
    for (let i = 0; i < messagesToMark.length; i += 20) {
        const batch = db.batch();
        const chunk = messagesToMark.slice(i, i + 20);
        
        chunk.forEach(doc => {
            batch.update(doc.ref, {
                deleted: true,
                deletedAt: new Date().toISOString(),
                deletedBy: 'auto-clean'
            });
        });
        
        try {
            await batch.commit();
            marked += chunk.length;
            updateStatus(`–ü–æ–º–µ—á–µ–Ω–æ: ${marked}/${markCount}`);
        } catch (e) {
            console.log('–û—à–∏–±–∫–∞:', e.message);
        }
        
        await sleep(500);
    }
    
    // 5. –°–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    await messagesRef.add({
        text: `üßπ –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞: ${marked} —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–º–µ—á–µ–Ω–æ –∫–∞–∫ —É–¥–∞–ª–µ–Ω–Ω—ã–µ.`,
        userId: 'system-clean',
        userName: '–°–∏—Å—Ç–µ–º–∞',
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        isSystem: true
    });
    
    // 6. –†–µ–∑—É–ª—å—Ç–∞—Ç
    document.getElementById('result').innerHTML = `
        <div style="background:#d4edda; padding:20px; border-radius:10px; margin-top:20px;">
            <h3>‚úÖ –ì–û–¢–û–í–û</h3>
            <p><strong>–í—Å–µ–≥–æ –±—ã–ª–æ:</strong> ${totalMessages} —Å–æ–æ–±—â–µ–Ω–∏–π</p>
            <p><strong>–ü–æ–º–µ—á–µ–Ω–æ —É–¥–∞–ª–µ–Ω–Ω—ã–º–∏:</strong> ${marked}</p>
            <p><strong>–û—Å—Ç–∞–≤–ª–µ–Ω–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö:</strong> ${keepCount}</p>
            <p><strong>–í—Ä–µ–º—è:</strong> ${new Date().toLocaleString()}</p>
        </div>
    `;
}

function updateStatus(msg) {
    document.getElementById('status').textContent = msg;
    console.log(msg);
}

function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', () => {
    const url = new URL(window.location.href);
    if (url.searchParams.has('key')) {
        startCleanup();
    } else {
        updateStatus('–î–æ–±–∞–≤—å ?key=electric2024 –≤ URL');
    }
});
</script>
</body>
</html>
