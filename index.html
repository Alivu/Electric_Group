<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin-allow-popups">
    <meta property="og:title" content="–ß–∞—Ç –≠–ª–µ–∫—Ç—Ä–æ—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –°–æ–æ–±—â–µ—Å—Ç–≤–∞ ¬´Electric Group¬ª">
    <meta property="og:description" content="–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ —ç–ª–µ–∫—Ç—Ä–∏–∫–æ–≤. –û–±—Å—É–∂–¥–µ–Ω–∏–µ, –ø–æ–º–æ—â—å, —Ä–µ—à–µ–Ω–∏—è.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://alivu.github.io/Electric_Group/">
    <meta property="og:image" content="https://alivu.github.io/Icon/icon-512x512.png">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="–ß–∞—Ç –≠–ª–µ–∫—Ç—Ä–æ—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –°–æ–æ–±—â–µ—Å—Ç–≤–∞ ¬´Electric Group¬ª">
    <meta name="twitter:description" content="–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ —ç–ª–µ–∫—Ç—Ä–∏–∫–æ–≤. –û–±—Å—É–∂–¥–µ–Ω–∏–µ, –ø–æ–º–æ—â—å, —Ä–µ—à–µ–Ω–∏—è.">
    <meta name="twitter:image" content="https://alivu.github.io/Icon/icon-512x512.png">
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin">
    <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow: hidden;
        }

        /* –°–¢–ò–õ–ò –î–õ–Ø –ê–£–î–ò–û–ó–ê–ü–ò–°–ò */
        .audio-btn {
            background: linear-gradient(135deg, #FF9800 0%, #FF5722 100%);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-right: 5px;
        }

        .audio-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.3);
        }

        .audio-btn.recording {
            background: #dc3545;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .audio-recording-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .audio-recording-modal {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .recording-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .recording-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #dc3545;
            font-weight: bold;
        }

        .recording-dot {
            width: 12px;
            height: 12px;
            background: #dc3545;
            border-radius: 50%;
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .recording-timer {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c5364;
            font-family: monospace;
        }

        .audio-visualizer {
            height: 100px;
            margin: 25px 0;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 3px;
        }

        .visualizer-bar {
            width: 8px;
            background: linear-gradient(to top, #2c5364, #4CAF50);
            border-radius: 4px 4px 0 0;
            min-height: 5px;
        }

        .recording-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }

        .cancel-recording-btn, .stop-recording-btn {
            padding: 12px 25px;
            border-radius: 25px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .cancel-recording-btn {
            background: #f8f9fa;
            color: #666;
            border: 2px solid #ddd;
        }

        .cancel-recording-btn:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .stop-recording-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
            color: white;
            border: 2px solid #4CAF50;
        }

        .stop-recording-btn:hover {
            background: linear-gradient(135deg, #45a049 0%, #1B5E20 100%);
            transform: translateY(-2px);
        }

        .recording-tip {
            margin-top: 20px;
            color: #666;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .audio-preview-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .audio-preview-modal {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            text-align: center;
        }

        .audio-preview-modal h3 {
            color: #2c5364;
            margin-bottom: 25px;
        }

        .audio-player {
            margin: 25px 0;
            display: flex;
            align-items: center;
            gap: 15px;
            justify-content: center;
        }

        .audio-player audio {
            flex: 1;
            max-width: 300px;
        }

        .audio-duration {
            font-weight: bold;
            color: #2c5364;
            min-width: 50px;
        }

        .preview-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 25px 0;
        }

        .delete-audio-btn, .send-audio-btn {
            padding: 12px 30px;
            border-radius: 25px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .delete-audio-btn {
            background: #f8f9fa;
            color: #dc3545;
            border: 2px solid #dc3545;
        }

        .delete-audio-btn:hover {
            background: #dc3545;
            color: white;
            transform: translateY(-2px);
        }

        .send-audio-btn {
            background: linear-gradient(135deg, #2c5364 0%, #203a43 100%);
            color: white;
            border: 2px solid #2c5364;
        }

        .send-audio-btn:hover {
            background: linear-gradient(135deg, #203a43 0%, #0f2027 100%);
            transform: translateY(-2px);
        }

        .audio-info {
            color: #666;
            font-size: 0.9rem;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .audio-message {
            margin-top: 10px;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 15px;
            border: 1px solid #e9ecef;
        }

        .audio-message audio {
            width: 100%;
            max-width: 300px;
        }

        .audio-message-info {
            font-size: 0.8rem;
            color: #666;
            margin-top: 8px;
            display: flex;
            justify-content: space-between;
        }

        /* –°–¢–ò–õ–ò –î–õ–Ø –ü–†–ï–í–¨–Æ –¶–ò–¢–ê–¢–´ */
        .quote-preview {
            background: rgba(44, 83, 100, 0.1);
            border-left: 4px solid #2c5364;
            padding: 12px 15px;
            border-radius: 8px;
            position: fixed;
            bottom: 150px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 50px);
            max-width: 800px;
            z-index: 100;
            display: none;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            box-sizing: border-box;
        }

        .quote-content {
            position: relative;
            padding-right: 25px;
        }

        .quote-content strong {
            color: #2c5364;
            font-size: 0.9em;
            font-weight: 600;
            display: block;
            margin-bottom: 4px;
        }

        .quote-content span {
            color: #666;
            font-size: 0.9em;
            line-height: 1.4;
            display: block;
            word-break: break-word;
        }

        .cancel-quote-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            background: white;
            border: 1px solid #ddd;
            color: #666;
            cursor: pointer;
            font-size: 16px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .cancel-quote-btn:hover {
            background: #f8f9fa;
            color: #dc3545;
        }

        .quoted-message {
            background: rgba(44, 83, 100, 0.08);
            border-left: 3px solid #2c5364;
            padding: 8px 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            font-size: 0.9em;
            max-width: 100%;
            overflow: hidden;
        }

        .quote-author {
            font-weight: bold;
            color: #2c5364;
            font-size: 0.85em;
            margin-bottom: 4px;
            display: block;
        }

        .quote-text {
            color: #666;
            line-height: 1.4;
            font-style: italic;
            display: block;
            word-break: break-word;
        }

        /* –û–°–ù–û–í–ù–´–ï –°–¢–ò–õ–ò */
        .back-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px 25px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            margin-right: 10px;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        .login-container {
            width: 100%;
            max-width: 500px;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .logo {
            font-size: 3rem;
            margin-bottom: 20px;
            color: #FF9800;
        }

        h1 {
            color: #2c5364;
            margin-bottom: 10px;
            font-size: 2rem;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1rem;
            line-height: 1.5;
        }

        .online-stats {
            background: linear-gradient(135deg, #2c5364 0%, #203a43 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
            box-shadow: 0 10px 30px rgba(44, 83, 100, 0.3);
        }

        .online-count {
            font-size: 3.5rem;
            font-weight: bold;
            display: block;
            line-height: 1;
            margin-bottom: 10px;
        }

        .online-label {
            font-size: 1rem;
            opacity: 0.9;
        }

        .google-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            width: 100%;
            background: #4285F4;
            color: white;
            border: none;
            border-radius: 50px;
            padding: 16px 30px;
            font-size: 1.1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(66, 133, 244, 0.3);
        }

        .google-btn:hover {
            background: #3367D6;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(66, 133, 244, 0.4);
        }

        .google-btn img {
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            padding: 4px;
        }

        .benefits {
            text-align: left;
            margin-top: 30px;
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            border-left: 4px solid #FF9800;
        }

        .benefits h3 {
            color: #2c5364;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .benefits ul {
            list-style: none;
            padding: 0;
        }

        .benefits li {
            padding: 10px 0;
            padding-left: 30px;
            position: relative;
            border-bottom: 1px solid #eee;
        }

        .benefits li:last-child {
            border-bottom: none;
        }

        .benefits li:before {
            content: "‚ö°";
            color: #FF9800;
            position: absolute;
            left: 0;
            font-size: 1.2rem;
        }

        .status {
            margin-top: 20px;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: bold;
            display: none;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            display: block;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            display: block;
        }

        .chat-container {
            width: 100%;
            max-width: 1200px;
            height: 90vh;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            display: none;
            flex-direction: column;
        }

        .chat-header {
            background: linear-gradient(135deg, #2c5364 0%, #203a43 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid rgba(255,255,255,0.3);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-details h3 {
            margin: 0;
            font-size: 1.2rem;
        }

        .user-details p {
            margin: 5px 0 0 0;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .chat-stats {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .online-badge {
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .online-dot {
            width: 10px;
            height: 10px;
            background: #4CAF50;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .logout-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px 25px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        .messages-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f8f9fa;
            overflow: hidden;
        }

        .messages-container {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            -webkit-overflow-scrolling: touch;
            min-height: 0;
        }

        .message {
            position: relative;
            display: flex;
            flex-direction: column;
            max-width: 70%;
            animation: messageAppear 0.3s ease-out;
            flex-shrink: 0;
        }

        @keyframes messageAppear {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.sent {
            align-self: flex-end;
        }

        .message.received {
            align-self: flex-start;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
            padding: 0 10px;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            overflow: hidden;
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .message-author {
            font-weight: 600;
            font-size: 0.9rem;
            color: #2c5364;
        }

        .message-time {
            font-size: 0.8rem;
            color: #888;
        }

        .message-content {
            background: white;
            padding: 15px 20px;
            border-radius: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            line-height: 1.5;
            word-break: break-word;
        }

        .message.sent .message-content {
            background: linear-gradient(135deg, #2c5364 0%, #203a43 100%);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message.received .message-content {
            border-bottom-left-radius: 5px;
        }

        .message-actions {
            display: none;
            position: absolute;
            top: 8px;
            right: 10px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 6px 10px;
            z-index: 10;
            opacity: 0;
            transform: translateY(5px);
            transition: opacity 0.2s, transform 0.2s;
        }

        .message.sent:hover .message-actions,
        .message.received:hover .message-actions {
            display: flex;
            gap: 8px;
            opacity: 1;
            transform: translateY(0);
        }

        .edit-btn, .delete-btn {
            background: none;
            border: none;
            padding: 6px 12px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
        }

        .edit-btn {
            color: #2c5364;
            background: rgba(44, 83, 100, 0.1);
            border: 1px solid rgba(44, 83, 100, 0.2);
        }

        .edit-btn:hover {
            background: rgba(44, 83, 100, 0.2);
            transform: translateY(-1px);
        }

        .delete-btn {
            color: #dc3545;
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid rgba(220, 53, 69, 0.2);
        }

        .delete-btn:hover {
            background: rgba(220, 53, 69, 0.2);
            transform: translateY(-1px);
        }

        .edit-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #2c5364;
            border-radius: 15px;
            font-size: 1rem;
            font-family: inherit;
            resize: none;
            min-height: 70px;
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .edit-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .save-btn, .cancel-btn {
            padding: 10px 24px;
            border-radius: 20px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .save-btn {
            background: linear-gradient(135deg, #2c5364 0%, #203a43 100%);
            color: white;
        }

        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(44, 83, 100, 0.3);
        }

        .cancel-btn {
            background: #f8f9fa;
            color: #666;
            border: 1px solid #ddd;
        }

        .cancel-btn:hover {
            background: #e9ecef;
        }

        .edited-badge {
            font-size: 0.75rem;
            color: #888;
            font-style: italic;
            margin-left: 8px;
            opacity: 0.8;
        }

        .message-input-area {
            padding: 20px 25px;
            background: white;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-shrink: 0;
            position: relative;
        }

        .message-input {
            flex: 1;
            padding: 15px 25px;
            border: 2px solid #e9ecef;
            border-radius: 30px;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s;
            -webkit-appearance: none;
        }

        .message-input:focus {
            border-color: #2c5364;
            box-shadow: 0 0 0 3px rgba(44, 83, 100, 0.1);
        }

        .send-btn {
            background: linear-gradient(135deg, #FF9800 0%, #FF5722 100%);
            color: white;
            border: none;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.3);
            flex-shrink: 0;
        }

        .send-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 20px rgba(255, 152, 0, 0.4);
        }

        .typing-indicator {
            padding: 10px 20px;
            background: #e9ecef;
            border-radius: 20px;
            margin: 0 25px 15px;
            font-style: italic;
            color: #666;
            display: none;
            flex-shrink: 0;
        }

        .message.system {
            align-self: center;
            max-width: 90%;
            text-align: center;
            margin: 10px 0;
        }

        .message.editing {
            animation: pulseHighlight 2s infinite;
        }

        .message.editing .message-content {
            box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.4);
            border: 2px solid #FF9800;
            transform: translateY(-2px);
        }

        @keyframes pulseHighlight {
            0% { transform: scale(1); }
            50% { transform: scale(1.01); }
            100% { transform: scale(1); }
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            max-height: 70vh;
            overflow: hidden;
        }

        .modal-header {
            background: #2c5364;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.1rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
        }

        .modal-body {
            padding: 20px;
            max-height: 50vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 15px 20px;
            text-align: center;
            border-top: 1px solid #eee;
        }

        .modal-btn {
            background: #2c5364;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 20px;
            cursor: pointer;
        }

        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
        }

        /* –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ */
        @media (max-width: 768px) {
            body {
                padding: 0;
            }
            
            .chat-container {
                height: 100vh;
                height: -webkit-fill-available;
                border-radius: 0;
                max-width: 100%;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                padding-bottom: env(safe-area-inset-bottom);
            }
            
            .login-container {
                padding: 25px;
                margin: 10px;
                border-radius: 15px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .online-count {
                font-size: 2.5rem;
            }
            
            .chat-header {
                padding: 8px 15px;
                padding-top: max(8px, env(safe-area-inset-top));
                min-height: 60px;
            }
            
            .user-avatar {
                width: 40px;
                height: 40px;
            }
            
            .user-details h3 {
                font-size: 0.9rem;
                max-width: 120px;
            }
            
            .user-details p {
                font-size: 0.75rem;
                max-width: 120px;
            }
            
            .chat-stats {
                gap: 2px;
                height: 40px;
            }
            
            .online-badge {
                padding: 4px 6px;
                font-size: 0.8rem;
                height: 32px;
            }
            
            .online-dot {
                width: 8px;
                height: 8px;
            }
            
            .back-btn, .logout-btn {
                padding: 6px 10px;
                font-size: 0.8rem;
                height: 32px;
                min-width: 55px;
            }
            
            .messages-container {
                padding: 15px 15px 95px;
            }
            
            .message {
                max-width: 85%;
            }
            
            .message-input-area {
                padding: 12px 15px;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: white;
                z-index: 100;
                border-top: 1px solid #e9ecef;
                box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
                padding-bottom: max(12px, env(safe-area-inset-bottom));
            }
            
            .messages-wrapper {
                padding-bottom: calc(70px + env(safe-area-inset-bottom));
            }
            
            .quote-preview {
                position: fixed;
                bottom: 60px;
                left: 15px;
                right: 15px;
                margin: 0 !important;
                padding: 10px 12px;
                z-index: 1000;
                border-radius: 8px 8px 0 0;
                box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            }
            
            .messages-container {
                padding-bottom: 120px !important;
            }
            
            .message-actions {
                top: -12px;
                right: 10px;
                padding: 5px 8px;
            }
            
            .edit-btn, .delete-btn {
                padding: 5px 10px;
                font-size: 0.8rem;
                min-width: 35px;
            }
            
            .message.sent:active .message-actions {
                display: flex;
                opacity: 1;
                transform: translateY(0);
            }
            
            .message.sent .message-content {
                position: relative;
                padding-right: 40px;
            }
            
            .audio-btn {
                width: 40px;
                height: 40px;
                font-size: 1rem;
                margin-right: 8px;
            }
            
            .audio-recording-modal {
                padding: 20px;
                margin: 15px;
                width: calc(100% - 30px);
            }
            
            .recording-controls {
                flex-direction: column;
            }
            
            .cancel-recording-btn, .stop-recording-btn {
                width: 100%;
            }
            
            .audio-player {
                flex-direction: column;
            }
            
            .preview-controls {
                flex-direction: column;
            }
            
            .delete-audio-btn, .send-audio-btn {
                width: 100%;
            }
        }
    </style>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
</head>
<body>
    <!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ -->
    <div class="login-container" id="loginScreen">
        <div class="logo">üîå</div>
        <h1>–≠–ª–µ–∫—Ç—Ä–æ—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –°–æ–æ–±—â–µ—Å—Ç–≤–æ ¬´Electric Group</h1>
        <p class="subtitle">–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ –¥–ª—è –æ–±–º–µ–Ω–∞ –æ–ø—ã—Ç–æ–º, –æ–±—Å—É–∂–¥–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–æ–≤ –∏ —Ä–µ—à–µ–Ω–∏—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–¥–∞—á</p>
        
        <div class="online-stats">
            <span class="online-count" id="onlineCount">0</span>
            <span class="online-label">—ç–ª–µ–∫—Ç—Ä–∏–∫–æ–≤ –æ–Ω–ª–∞–π–Ω —Å–µ–π—á–∞—Å</span>
        </div>
        
        <button class="google-btn" id="googleLoginBtn">
            <img src="https://www.google.com/favicon.ico" alt="Google">
            –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
        </button>
        
        <div class="benefits">
            <h3><span>‚ö°</span> –ß—Ç–æ –¥–∞—ë—Ç –Ω–∞—à —á–∞—Ç —ç–ª–µ–∫—Ç—Ä–∏–∫–∞–º:</h3>
            <ul>
                <li>–û–±—Å—É–∂–¥–∞–µ–º –ª—é–±—ã–µ –º–æ–Ω—Ç–∞–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏</li>
                <li>–ü–æ–º–æ–≥–∞–µ–º —Å –ü–£–≠ –∏ –¥—Ä—É–≥–∏–º–∏ –Ω–æ—Ä–º–∞–º–∏</li>
                <li>–ü–æ–¥–±–∏—Ä–∞–µ–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</li>
                <li>–û–±–º–µ–Ω–∏–≤–∞–µ–º—Å—è —Å—Ö–µ–º–∞–º–∏ –∏ –ø—Ä–æ–µ–∫—Ç–∞–º–∏</li>
                <li>–ö–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ–º —Ä–∞–±–æ—Ç—É –Ω–∞ –æ–±—ä–µ–∫—Ç–∞—Ö</li>
            </ul>
        </div>
        
        <div class="status" id="statusMessage"></div>
    </div>
    
    <!-- –≠–∫—Ä–∞–Ω —á–∞—Ç–∞ -->
    <div class="chat-container" id="chatScreen">
        <!-- –®–∞–ø–∫–∞ —á–∞—Ç–∞ -->
        <div class="chat-header">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar"></div>
                <div class="user-details">
                    <h3 id="userName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h3>
                    <p id="userEmail">email@example.com</p>
                </div>
            </div>
            
            <div class="chat-stats">
                <div class="online-badge" id="onlineBadge" style="cursor: pointer;">
                    <span class="online-dot"></span>
                    <span id="activeOnlineCount">0</span> –æ–Ω–ª–∞–π–Ω
                </div>
                <button class="back-btn" id="backBtn">–ù–∞–∑–∞–¥</button>
                <button class="logout-btn" id="logoutBtn">–í—ã–π—Ç–∏</button>
            </div>
        </div>
        
        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π -->
        <div class="messages-wrapper">
            <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä "–ø–µ—á–∞—Ç–∞–µ—Ç" -->
            <div class="typing-indicator" id="typingIndicator"></div>
            
            <!-- –ë–ª–æ–∫ –¥–ª—è –ø—Ä–µ–≤—å—é —Ü–∏—Ç–∞—Ç—ã -->
            <div class="quote-preview" id="quotePreview" style="display: none;">
                <div class="quote-content">
                    <strong id="quoteAuthor">–ê–≤—Ç–æ—Ä</strong>
                    <span id="quoteText">–¢–µ–∫—Å—Ç —Ü–∏—Ç–∞—Ç—ã...</span>
                    <button class="cancel-quote-btn" id="cancelQuoteBtn">√ó</button>
                </div>
            </div>
            
            <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
            <div class="messages-container" id="messagesContainer">
                <div class="message system">
                    <div class="message-content" style="text-align: center; background: #e9ecef; color: #666;">
                        –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —á–∞—Ç —ç–ª–µ–∫—Ç—Ä–∏–∫–æ–≤! –ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ.
                    </div>
                </div>
            </div>
            
            <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ -->
            <div class="message-input-area">
                <button class="audio-btn" id="audioRecordBtn" title="–ó–∞–ø–∏—Å–∞—Ç—å –∞—É–¥–∏–æ—Å–æ–æ–±—â–µ–Ω–∏–µ">üé§</button>
                <input type="text" class="message-input" id="messageInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." maxlength="1000">
                <button class="send-btn" id="sendMessageBtn">‚û§</button>
            </div>
        </div>
    </div>
    
    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏ –∞—É–¥–∏–æ -->
    <div class="audio-recording-overlay" id="audioRecordingOverlay" style="display: none;">
        <div class="audio-recording-modal">
            <div class="recording-header">
                <div class="recording-indicator">
                    <span class="recording-dot"></span>
                    <span>–ó–∞–ø–∏—Å—å...</span>
                </div>
                <div class="recording-timer" id="recordingTimer">00:00</div>
            </div>
            
            <div class="audio-visualizer" id="audioVisualizer"></div>
            
            <div class="recording-controls">
                <button class="cancel-recording-btn" id="cancelRecordingBtn">‚ùå –û—Ç–º–µ–Ω–∞</button>
                <button class="stop-recording-btn" id="stopRecordingBtn">‚èπÔ∏è –ó–∞–≤–µ—Ä—à–∏—Ç—å (0:30)</button>
            </div>
            
            <div class="recording-tip">üé§ –ì–æ–≤–æ—Ä–∏—Ç–µ —á–µ—Ç–∫–æ. –ú–∞–∫—Å–∏–º—É–º 60 —Å–µ–∫—É–Ω–¥.</div>
        </div>
    </div>
    
    <!-- –ü—Ä–µ–≤—å—é –∞—É–¥–∏–æ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π -->
    <div class="audio-preview-overlay" id="audioPreviewOverlay" style="display: none;">
        <div class="audio-preview-modal">
            <h3>üéß –ü—Ä–æ—Å–ª—É—à–∞—Ç—å –∞—É–¥–∏–æ—Å–æ–æ–±—â–µ–Ω–∏–µ</h3>
            
            <div class="audio-player">
                <audio controls id="audioPreviewPlayer">–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ.</audio>
                <div class="audio-duration" id="audioDuration">0:00</div>
            </div>
            
            <div class="preview-controls">
                <button class="delete-audio-btn" id="deleteAudioBtn">‚ùå –£–¥–∞–ª–∏—Ç—å</button>
                <button class="send-audio-btn" id="sendAudioBtn">‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
            
            <div class="audio-info">
                –†–∞–∑–º–µ—Ä: <span id="audioSize">0 KB</span>
                | –î–ª–∏–Ω–∞: <span id="audioLength">0 —Å–µ–∫</span>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
    <div class="modal-overlay" id="onlineModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏ –æ–Ω–ª–∞–π–Ω</h3>
                <button class="modal-close" id="closeOnlineModal">√ó</button>
            </div>
            <div class="modal-body" id="onlineUsersList">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn" id="closeOnlineModalBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
    // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE ==========
    const firebaseConfig = {
        apiKey: "AIzaSyCRJh0fFbJAc6dFz1O21SbjyAaPbMV58xc",
        authDomain: "electrician-chat.firebaseapp.com",
        projectId: "electrician-chat",
        storageBucket: "electrician-chat.firebasestorage.app",
        messagingSenderId: "1005885507362",
        appId: "1:1005885507362:web:c030a98505761b0add877b"
    };

    // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
    let auth, db, storage;
    let chat = null;

    // ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function showStatus(message, type) {
        const statusEl = document.getElementById('statusMessage');
        if (!statusEl) return;
        
        statusEl.textContent = message;
        statusEl.className = 'status ' + type;
        statusEl.style.display = 'block';
        
        setTimeout(() => {
            if (statusEl) {
                statusEl.style.display = 'none';
            }
        }, 3000);
    }

    // ========== –ö–õ–ê–°–° –≠–õ–ï–ö–¢–†–ò–ö –ß–ê–¢ ==========
    class ElectricianChat {
        constructor() {
            console.log('üî¥ –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä ElectricianChat –í–´–ó–í–ê–ù!');
            
            this.user = null;
            this.roomId = 'brotherhood-electricians-chr'; // ‚Üê –ò–°–ü–†–ê–í–¨–¢–ï –≠–¢–û!
            this.unsubscribeMessages = null;
            this.unsubscribeOnline = null;
            this.unsubscribeTyping = null;
            this.firstMessageSent = false;
            this.systemMessageRemoved = false;
            
            // RATE LIMITING
            this.lastMessageTime = 0;
            this.messageCooldown = 3000;
            this.isSending = false;

            // –ê–£–î–ò–û –ü–ï–†–ï–ú–ï–ù–ù–´–ï
            this.mediaRecorder = null;
            this.audioChunks = [];
            this.isRecording = false;
            this.recordingStartTime = null;
            this.recordingTimer = null;
            this.maxRecordingTime = 60000;
            this.currentAudioBlob = null;
            this.audioContext = null;
            this.analyser = null;
            this.visualizerInterval = null;
            this.pendingQuote = null;
            
            // –ü–†–û–ö–†–£–¢–ö–ê
            this.shouldAutoScroll = true;
            this.userScrolledUp = false;
            
            this.init();
        }
        
        // ========== –ù–ê–ß–ê–õ–û: –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        init() {
            this.getDOMElements();
            this.setupEventListeners();
            this.setupAuthListener();
            
            console.log("‚úÖ –ß–∞—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
        }
        
        getDOMElements() {
            this.loginScreen = document.getElementById('loginScreen');
            this.chatScreen = document.getElementById('chatScreen');
            this.googleLoginBtn = document.getElementById('googleLoginBtn');
            this.logoutBtn = document.getElementById('logoutBtn');
            this.userName = document.getElementById('userName');
            this.userEmail = document.getElementById('userEmail');
            this.userAvatar = document.getElementById('userAvatar');
            this.onlineCount = document.getElementById('onlineCount');
            this.activeOnlineCount = document.getElementById('activeOnlineCount');
            this.messagesContainer = document.getElementById('messagesContainer');
            this.messageInput = document.getElementById('messageInput');
            this.sendMessageBtn = document.getElementById('sendMessageBtn');
            this.typingIndicator = document.getElementById('typingIndicator');
        }
        
        setupEventListeners() {
            // –ö–Ω–æ–ø–∫–∏ –≤—Ö–æ–¥–∞/–≤—ã—Ö–æ–¥–∞
            this.googleLoginBtn.addEventListener('click', () => this.signInWithGoogle());
            this.logoutBtn.addEventListener('click', () => this.signOut());
            
            // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
            const backBtn = document.getElementById('backBtn');
            if (backBtn) {
                backBtn.addEventListener('click', () => {
                    if (confirm('–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É?')) {
                        window.location.href = 'https://alivu.github.io/';
                    }
                });
            }
            
            // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
            this.sendMessageBtn.addEventListener('click', () => this.sendMessage());
            this.messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.sendMessage();
                }
            });
            
            // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞
            this.messageInput.addEventListener('input', () => this.setTypingStatus(true));
            this.messageInput.addEventListener('blur', () => this.setTypingStatus(false));
            
            // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞
            this.messagesContainer.addEventListener('scroll', () => this.handleScroll());
            
            // –ê–¥–∞–ø—Ç–∞—Ü–∏—è –∫ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ
            window.addEventListener('resize', () => {
                if (this.user) {
                    setTimeout(() => this.scrollToBottom(), 300);
                }
            });
            
            // –ê–£–î–ò–û –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò
            const audioRecordBtn = document.getElementById('audioRecordBtn');
            const cancelRecordingBtn = document.getElementById('cancelRecordingBtn');
            const stopRecordingBtn = document.getElementById('stopRecordingBtn');
            const deleteAudioBtn = document.getElementById('deleteAudioBtn');
            const sendAudioBtn = document.getElementById('sendAudioBtn');
            
            if (audioRecordBtn) {
                audioRecordBtn.addEventListener('click', () => this.toggleAudioRecording());
            }
            
            if (cancelRecordingBtn) {
                cancelRecordingBtn.addEventListener('click', () => this.cancelAudioRecording());
            }
            
            if (stopRecordingBtn) {
                stopRecordingBtn.addEventListener('click', () => this.stopAudioRecording());
            }
            
            if (deleteAudioBtn) {
                deleteAudioBtn.addEventListener('click', () => this.deleteAudioPreview());
            }
            
            if (sendAudioBtn) {
                sendAudioBtn.addEventListener('click', () => this.sendAudioMessage());
            }
            
            // –¶–∏—Ç–∞—Ç—ã
            const cancelQuoteBtn = document.getElementById('cancelQuoteBtn');
            if (cancelQuoteBtn) {
                cancelQuoteBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    this.cancelQuote();
                });
            }
            
            // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ–Ω–ª–∞–π–Ω
            const onlineBadge = document.getElementById('onlineBadge');
            if (onlineBadge) {
                onlineBadge.addEventListener('click', () => {
                    document.getElementById('onlineModal').style.display = 'flex';
                });
            }
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            const closeBtn1 = document.getElementById('closeOnlineModal');
            const closeBtn2 = document.getElementById('closeOnlineModalBtn');
            const modalOverlay = document.getElementById('onlineModal');
            
            if (closeBtn1) {
                closeBtn1.addEventListener('click', () => {
                    modalOverlay.style.display = 'none';
                });
            }
            if (closeBtn2) {
                closeBtn2.addEventListener('click', () => {
                    modalOverlay.style.display = 'none';
                });
            }
            if (modalOverlay) {
                modalOverlay.addEventListener('click', (e) => {
                    if (e.target === modalOverlay) {
                        modalOverlay.style.display = 'none';
                    }
                });
            }
            
            // ESC –¥–ª—è –æ—Ç–º–µ–Ω—ã —Ü–∏—Ç–∞—Ç—ã
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    const quotePreview = document.getElementById('quotePreview');
                    if (quotePreview && quotePreview.style.display === 'block') {
                        this.cancelQuote();
                        this.messageInput.focus();
                    }
                }
            });
        }
        
        setupAuthListener() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    this.onUserSignedIn(user);
                } else {
                    this.onUserSignedOut();
                }
            });
        }
        // ========== –ö–û–ù–ï–¶: –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        
        // ========== –ù–ê–ß–ê–õ–û: –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ==========
        async signInWithGoogle() {
            try {
                const googleProvider = new firebase.auth.GoogleAuthProvider();
                googleProvider.addScope('profile');
                googleProvider.addScope('email');
                googleProvider.setCustomParameters({ prompt: 'select_account' });
                
                showStatus("–ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ Google...", "info");
                const result = await auth.signInWithPopup(googleProvider);
                this.user = result.user;
                
                await this.saveUserToFirestore(this.user);
                showStatus("‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥!", "success");
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:", error);
                let errorMessage = "–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ";
                
                if (error.code === 'auth/popup-blocked') {
                    errorMessage += "–ë—Ä–∞—É–∑–µ—Ä –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ.";
                } else if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = "–û–∫–Ω–æ –≤—Ö–æ–¥–∞ –±—ã–ª–æ –∑–∞–∫—Ä—ã—Ç–æ";
                } else {
                    errorMessage += error.message;
                }
                
                showStatus(errorMessage, "error");
            }
        }
        
        async saveUserToFirestore(user) {
            try {
                await db.collection('users').doc(user.uid).set({
                    uid: user.uid,
                    displayName: user.displayName || '–≠–ª–µ–∫—Ç—Ä–∏–∫',
                    email: user.email,
                    photoURL: user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || 'E')}&background=2c5364&color=fff`,
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                    isOnline: true,
                    profession: 'electrician',
                    joinedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                console.log("‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ Firestore");
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", error);
            }
        }
        
        async signOut() {
            try {
                if (this.user) {
                    await db.collection('rooms').doc(this.roomId)
                        .collection('online').doc(this.user.uid).delete();
                    
                    await db.collection('rooms').doc(this.roomId)
                        .collection('typing').doc(this.user.uid).delete();
                }
                
                this.firstMessageSent = false;
                this.systemMessageRemoved = false;
                await auth.signOut();
                showStatus("‚úÖ –í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã", "success");
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:", error);
                showStatus("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ: " + error.message, "error");
            }
        }
        
        onUserSignedIn(user) {
            this.user = user;
            
            this.userName.textContent = user.displayName || '–≠–ª–µ–∫—Ç—Ä–∏–∫';
            this.userEmail.textContent = user.email || '';
            
            if (user.photoURL) {
                this.userAvatar.innerHTML = `<img src="${user.photoURL}" alt="${user.displayName}">`;
            } else {
                const name = user.displayName || 'E';
                this.userAvatar.innerHTML = `<div style="width:100%;height:100%;background:#2c5364;color:white;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:1.2rem;">${name.charAt(0).toUpperCase()}</div>`;
            }
            
            this.loginScreen.style.display = 'none';
            this.chatScreen.style.display = 'flex';
            
            this.loadOnlineUsers();
            this.subscribeToMessages();
            this.subscribeToTyping();
            this.addUserToOnline();
            
            setTimeout(() => {
                this.messageInput.focus();
            }, 100);
        }
        
        onUserSignedOut() {
            this.user = null;
            
            if (this.unsubscribeMessages) this.unsubscribeMessages();
            if (this.unsubscribeOnline) this.unsubscribeOnline();
            if (this.unsubscribeTyping) this.unsubscribeTyping();
            
            this.chatScreen.style.display = 'none';
            this.loginScreen.style.display = 'block';
            
            this.firstMessageSent = false;
            this.systemMessageRemoved = false;
            this.shouldAutoScroll = true;
            this.userScrolledUp = false;
            
            this.messagesContainer.innerHTML = `
                <div class="message system">
                    <div class="message-content" style="text-align: center; background: #e9ecef; color: #666;">
                        –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —á–∞—Ç —ç–ª–µ–∫—Ç—Ä–∏–∫–æ–≤! –ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ.
                    </div>
                </div>
            `;
        }
        // ========== –ö–û–ù–ï–¶: –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ==========
        
        // ========== –ù–ê–ß–ê–õ–û: –û–ù–õ–ê–ô–ù –°–¢–ê–¢–£–° ==========
        async addUserToOnline() {
            if (!this.user) return;
            
            try {
                await db.collection('rooms').doc(this.roomId)
                    .collection('online').doc(this.user.uid).set({
                        uid: this.user.uid,
                        name: this.user.displayName || '–≠–ª–µ–∫—Ç—Ä–∏–∫',
                        email: this.user.email,
                        photoURL: this.user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(this.user.displayName || 'E')}&background=2c5364&color=fff`,
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                    });
                
                setInterval(() => {
                    if (this.user) {
                        db.collection('rooms').doc(this.roomId)
                            .collection('online').doc(this.user.uid).update({
                                lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                            });
                    }
                }, 30000);
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –æ–Ω–ª–∞–π–Ω:", error);
            }
        }
        
        async loadOnlineUsers() {
            try {
                const onlineRef = db.collection('rooms').doc(this.roomId).collection('online');
                
                this.unsubscribeOnline = onlineRef.onSnapshot((snapshot) => {
                    let onlineCount = 0;
                    snapshot.forEach((doc) => {
                        const user = doc.data();
                        const lastSeen = user.lastSeen ? user.lastSeen.toDate() : new Date();
                        const isActive = (new Date() - lastSeen) < 120000;
                        
                        if (isActive) onlineCount++;
                    });
                    
                    if (this.onlineCount) this.onlineCount.textContent = onlineCount;
                    if (this.activeOnlineCount) this.activeOnlineCount.textContent = onlineCount;
                    
                }, (error) => {
                    console.error("‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:", error);
                });
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:", error);
            }
        }
        // ========== –ö–û–ù–ï–¶: –û–ù–õ–ê–ô–ù –°–¢–ê–¢–£–° ==========
        
        // ========== –ù–ê–ß–ê–õ–û: –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–ô ==========
        updateSendButton(isSending) {
            const sendBtn = document.getElementById('sendMessageBtn');
            if (!sendBtn) return;
            
            if (isSending) {
                sendBtn.innerHTML = "‚è≥";
                sendBtn.style.opacity = "0.7";
                sendBtn.style.cursor = "not-allowed";
                sendBtn.disabled = true;
            } else {
                sendBtn.innerHTML = "‚û§";
                sendBtn.style.opacity = "1";
                sendBtn.style.cursor = "pointer";
                sendBtn.disabled = false;
            }
        }
        
        async sendMessage() {
            const now = Date.now();
            const timeSinceLastMessage = now - this.lastMessageTime;
            
            if (timeSinceLastMessage < this.messageCooldown) {
                const remainingTime = Math.ceil((this.messageCooldown - timeSinceLastMessage) / 1000);
                showStatus(`‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ ${remainingTime} —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π`, "error");
                return;
            }
            
            if (this.isSending) {
                showStatus("‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è...", "info");
                return;
            }
            
            if (!this.user) {
                showStatus("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É", "error");
                return;
            }
            
            const text = this.messageInput.value.trim();
            if (!text) {
                if (document.getElementById('quotePreview').style.display === 'block') {
                    this.cancelQuote();
                    showStatus("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è", "info");
                }
                return;
            }
            
            try {
                this.isSending = true;
                this.lastMessageTime = Date.now();
                this.updateSendButton(true);
                
                if (!this.firstMessageSent) {
                    this.firstMessageSent = true;
                    this.systemMessageRemoved = true;
                }
                
                const messageData = {
                    text: text,
                    userId: this.user.uid,
                    userName: this.user.displayName || '–≠–ª–µ–∫—Ç—Ä–∏–∫',
                    userEmail: this.user.email,
                    userPhoto: this.user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(this.user.displayName || 'E')}&background=2c5364&color=fff`,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    isElectrician: true
                };
                
                const quotePreview = document.getElementById('quotePreview');
                if (quotePreview && quotePreview.style.display === 'block') {
                    const quoteId = quotePreview.getAttribute('data-quote-id');
                    const quoteAuthor = quotePreview.getAttribute('data-quote-author');
                    const quoteText = quotePreview.getAttribute('data-quote-text');
                    
                    if (quoteId && quoteAuthor && quoteText) {
                        messageData.replyTo = {
                            messageId: quoteId,
                            author: quoteAuthor,
                            text: quoteText
                        };
                    }
                }
                
                await db.collection('rooms').doc(this.roomId)
                    .collection('messages').add(messageData);
                
                this.isSending = false;
                this.updateSendButton(false);
                this.messageInput.value = '';
                this.cancelQuote();
                this.setTypingStatus(false);
                this.shouldAutoScroll = true;
                
                showStatus("‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ" + (messageData.replyTo ? " —Å —Ü–∏—Ç–∞—Ç–æ–π" : ""), "success");
                
            } catch (error) {
                this.isSending = false;
                this.updateSendButton(false);
                
                console.error("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:", error.code, error.message);
                
                let errorMessage = "–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ";
                if (error.code === 'permission-denied') {
                    errorMessage = "‚ùå –ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.";
                } else if (error.code === 'unauthenticated') {
                    errorMessage = "‚ùå –°–µ—Å—Å–∏—è —É—Å—Ç–∞—Ä–µ–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.";
                    setTimeout(() => this.signOut(), 2000);
                } else {
                    errorMessage += error.message;
                }
                
                showStatus(errorMessage, "error");
            }
        }
        // ========== –ö–û–ù–ï–¶: –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–ô ==========
        
        // ========== –ù–ê–ß–ê–õ–û: –ü–†–û–°–õ–£–®–ò–í–ê–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–ô ==========
        subscribeToMessages() {
            console.log('üîµ subscribeToMessages –í–´–ó–í–ê–ù');
            
            if (this.unsubscribeMessages) this.unsubscribeMessages();
            
            this.unsubscribeMessages = db.collection('rooms').doc(this.roomId)
                .collection('messages')
                .orderBy('timestamp', 'desc')
                .limit(20)
                .onSnapshot((snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added') {
                            const message = change.doc.data();
                            const docId = change.doc.id;
                            
                            if (!document.querySelector(`[data-message-id="${docId}"]`)) {
                                this.displayMessage(message, docId);
                            }
                        }
                    });
                }, (error) => {
                    console.error("‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:", error);
                });
        }
        
displayMessage(message, docId) {
    const isOwnMessage = message.userId === this.user?.uid;
    const messageTime = message.timestamp ? 
        new Date(message.timestamp.toDate()).toLocaleTimeString([], { 
            hour: '2-digit', 
            minute: '2-digit' 
        }) : 
        new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    
    const editedBadge = message.edited ? 
        `<span class="edited-badge">(—Ä–µ–¥.)</span>` : '';
    
    // –ù–∞—á–∏–Ω–∞–µ–º —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
    let contentHtml = '';
    
    // 1. –î–æ–±–∞–≤–ª—è–µ–º —Ü–∏—Ç–∞—Ç—É –µ—Å–ª–∏ –µ—Å—Ç—å
    if (message.replyTo) {
        const quoteText = message.replyTo.text || '';
        const shortText = quoteText.length > 100 ? 
            quoteText.substring(0, 100) + '...' : 
            quoteText;
        
        contentHtml += `
            <div class="quoted-message">
                <span class="quote-author">${message.replyTo.author || '–≠–ª–µ–∫—Ç—Ä–∏–∫'}:</span>
                <span class="quote-text">${escapeHtml(shortText)}</span>
            </div>
        `;
    }
    
    // 2. –î–æ–±–∞–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç
    if (message.type === 'audio' && message.audioData) {
        // Base64 –∞—É–¥–∏–æ
        const audioSrc = `data:audio/webm;base64,${message.audioData}`;
        contentHtml += `
            ${message.text ? `<p>${escapeHtml(message.text)}</p>` : ''}
            <div class="audio-message">
                <audio controls>
                    <source src="${audioSrc}" type="audio/webm">
                    –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ.
                </audio>
                <div class="audio-message-info">
                    <span>üé§ –ê—É–¥–∏–æ—Å–æ–æ–±—â–µ–Ω–∏–µ</span>
                    <span>${message.audioDuration || '0:00'}</span>
                    <span>${message.audioSize ? message.audioSize + ' KB' : ''}</span>
                </div>
            </div>
        `;
    } else {
        // –¢–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        contentHtml += escapeHtml(message.text || '');
    }
    
    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
    const messageEl = document.createElement('div');
    messageEl.className = `message ${isOwnMessage ? 'sent' : 'received'}`;
    messageEl.setAttribute('data-message-id', docId);
    
    messageEl.innerHTML = `
        <div class="message-header">
            <div class="message-avatar">
                ${message.userPhoto ? 
                    `<img src="${message.userPhoto}" alt="${message.userName}">` : 
                    `<div style="width:100%;height:100%;background:#2c5364;color:white;display:flex;align-items:center;justify-content:center;font-weight:bold;">${(message.userName || 'E').charAt(0).toUpperCase()}</div>`
                }
            </div>
            <span class="message-author">${message.userName || '–≠–ª–µ–∫—Ç—Ä–∏–∫'}</span>
            <span class="message-time">${messageTime} ${editedBadge}</span>
        </div>
        <div class="message-content">${contentHtml}</div>
    `;
    
    this.messagesContainer.appendChild(messageEl);
    this.addMessageActions(messageEl, message, docId);
    
    if (this.shouldAutoScroll) {
        setTimeout(() => this.scrollToBottom(), 100);
    }
    
    return messageEl;
}
        // ========== –ö–û–ù–ï–¶: –ü–†–û–°–õ–£–®–ò–í–ê–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–ô ==========
        
        // ========== –ù–ê–ß–ê–õ–û: –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –ò –£–î–ê–õ–ï–ù–ò–ï ==========
        addMessageActions(messageEl, messageData, docId) {
            const isOwnMessage = messageData.userId === this.user?.uid;
            
            let buttonsHtml = `
                <button class="reply-btn" data-id="${docId}" 
                        style="background: none; border: none; color: #2c5364; cursor: pointer; padding: 4px 8px; font-size: 0.85em; text-decoration: underline;">
                    –û—Ç–≤–µ—Ç–∏—Ç—å
                </button>
            `;
            
            if (isOwnMessage) {
                buttonsHtml = `
                    <button class="edit-btn" data-id="${docId}" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
                    ${buttonsHtml}
                    <button class="delete-btn" data-id="${docId}" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                `;
            }
            
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'message-actions';
            actionsDiv.innerHTML = buttonsHtml;
            
            messageEl.appendChild(actionsDiv);
            
            const replyBtn = actionsDiv.querySelector('.reply-btn');
            replyBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.startReplyToMessage(docId, messageData);
            });
            
            if (isOwnMessage) {
                const editBtn = actionsDiv.querySelector('.edit-btn');
                const deleteBtn = actionsDiv.querySelector('.delete-btn');
                
                editBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.startEditMessage(docId, messageData);
                });
                
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.deleteMessage(docId);
                });
            }
        }
        
        startEditMessage(docId, messageData) {
            const messageEl = document.querySelector(`[data-message-id="${docId}"]`);
            if (!messageEl) return;
            
            messageEl.classList.add('editing');
            const contentEl = messageEl.querySelector('.message-content');
            const originalText = messageData.text;
            
            const editHtml = `
                <textarea class="edit-input" maxlength="1000">${escapeHtml(originalText)}</textarea>
                <div class="edit-buttons">
                    <button class="cancel-btn">–û—Ç–º–µ–Ω–∞</button>
                    <button class="save-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            `;
            
            contentEl.innerHTML = editHtml;
            const textarea = contentEl.querySelector('.edit-input');
            textarea.focus();
            textarea.setSelectionRange(textarea.value.length, textarea.value.length);
            
            contentEl.querySelector('.cancel-btn').addEventListener('click', () => {
                this.cancelEdit(docId, originalText);
            });
            
            contentEl.querySelector('.save-btn').addEventListener('click', () => {
                const newText = textarea.value.trim();
                if (newText && newText !== originalText) {
                    this.saveEditedMessage(docId, newText);
                } else {
                    this.cancelEdit(docId, originalText);
                }
            });
            
            textarea.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    contentEl.querySelector('.save-btn').click();
                }
                if (e.key === 'Escape') {
                    contentEl.querySelector('.cancel-btn').click();
                }
            });
        }
        
        async saveEditedMessage(docId, newText) {
            if (!newText.trim()) return;
            
            try {
                await db.collection('rooms').doc(this.roomId)
                    .collection('messages').doc(docId).update({
                        text: newText,
                        edited: true,
                        editedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                
                showStatus("‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ", "success");
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:", error);
                showStatus("–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: " + error.message, "error");
            }
        }
        
        cancelEdit(docId, originalText) {
            const messageEl = document.querySelector(`[data-message-id="${docId}"]`);
            if (!messageEl) return;
            
            messageEl.classList.remove('editing');
            const contentEl = messageEl.querySelector('.message-content');
            contentEl.innerHTML = escapeHtml(originalText);
            this.addMessageActions(messageEl, { userId: this.user.uid }, docId);
        }
        
        async deleteMessage(docId) {
            if (!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?")) return;
            
            try {
                await db.collection('rooms').doc(this.roomId)
                    .collection('messages').doc(docId).delete();
                
                showStatus("‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ", "success");
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:", error.code, error.message);
                
                let errorMessage = "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ";
                if (error.code === 'permission-denied') {
                    errorMessage = "‚ùå –ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ —ç—Ç–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.";
                } else if (error.code === 'not-found') {
                    errorMessage = "‚ùå –°–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ –±—ã–ª–æ —É–¥–∞–ª–µ–Ω–æ.";
                } else {
                    errorMessage += error.message;
                }
                
                showStatus(errorMessage, "error");
            }
        }
        // ========== –ö–û–ù–ï–¶: –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –ò –£–î–ê–õ–ï–ù–ò–ï ==========
        
        // ========== –ù–ê–ß–ê–õ–û: –¶–ò–¢–ò–†–û–í–ê–ù–ò–ï ==========
        startReplyToMessage(docId, messageData) {
            const quotePreview = document.getElementById('quotePreview');
            if (!quotePreview) return;
            
            quotePreview.style.display = 'block';
            quotePreview.setAttribute('data-quote-id', docId);
            quotePreview.setAttribute('data-quote-author', messageData.userName || '–≠–ª–µ–∫—Ç—Ä–∏–∫');
            quotePreview.setAttribute('data-quote-text', messageData.text || '');
            
            document.getElementById('quoteAuthor').textContent = messageData.userName || '–≠–ª–µ–∫—Ç—Ä–∏–∫';
            const previewText = messageData.text && messageData.text.length > 60 ? 
                messageData.text.substring(0, 60) + '...' : (messageData.text || '');
            document.getElementById('quoteText').textContent = previewText;
            
            this.messageInput.focus();
        }
        
        cancelQuote() {
            const quotePreview = document.getElementById('quotePreview');
            if (quotePreview) {
                quotePreview.style.display = 'none';
                quotePreview.removeAttribute('data-quote-id');
                quotePreview.removeAttribute('data-quote-author');
                quotePreview.removeAttribute('data-quote-text');
                document.getElementById('quoteAuthor').textContent = '–ê–≤—Ç–æ—Ä';
                document.getElementById('quoteText').textContent = '–¢–µ–∫—Å—Ç —Ü–∏—Ç–∞—Ç—ã...';
            }
        }
        // ========== –ö–û–ù–ï–¶: –¶–ò–¢–ò–†–û–í–ê–ù–ò–ï ==========
        
        // ========== –ù–ê–ß–ê–õ–û: –¢–ò–ü–ò–ù–ì –ò–ù–î–ò–ö–ê–¢–û–† ==========
        async setTypingStatus(isTyping) {
            if (!this.user) return;
            
            try {
                if (isTyping) {
                    await db.collection('rooms').doc(this.roomId)
                        .collection('typing').doc(this.user.uid).set({
                            userId: this.user.uid,
                            userName: this.user.displayName || '–≠–ª–µ–∫—Ç—Ä–∏–∫',
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                } else {
                    await db.collection('rooms').doc(this.roomId)
                        .collection('typing').doc(this.user.uid).delete();
                }
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞–±–æ—Ä–∞:", error);
            }
        }
        
        subscribeToTyping() {
            this.unsubscribeTyping = db.collection('rooms').doc(this.roomId)
                .collection('typing')
                .onSnapshot((snapshot) => {
                    const typingUsers = [];
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        if (data.userId !== this.user?.uid) {
                            typingUsers.push(data.userName || '–≠–ª–µ–∫—Ç—Ä–∏–∫');
                        }
                    });
                    
                    this.showTypingIndicator(typingUsers);
                }, (error) => {
                    console.error("‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –Ω–∞–±–æ—Ä —Ç–µ–∫—Å—Ç–∞:", error);
                });
        }
        
        showTypingIndicator(typingUsers) {
            if (typingUsers.length > 0) {
                const names = typingUsers.slice(0, 2).join(', ');
                const others = typingUsers.length > 2 ? ` –∏ ${typingUsers.length - 2} –¥—Ä—É–≥–∏—Ö` : '';
                this.typingIndicator.textContent = `${names}${others} –ø–µ—á–∞—Ç–∞–µ—Ç...`;
                this.typingIndicator.style.display = 'block';
            } else {
                this.typingIndicator.style.display = 'none';
            }
        }
        // ========== –ö–û–ù–ï–¶: –¢–ò–ü–ò–ù–ì –ò–ù–î–ò–ö–ê–¢–û–† ==========
        
        // ========== –ù–ê–ß–ê–õ–û: –ü–†–û–ö–†–£–¢–ö–ê ==========
        handleScroll() {
            const container = this.messagesContainer;
            const scrollBottom = container.scrollHeight - container.scrollTop - container.clientHeight;
            
            if (scrollBottom <= 50) {
                this.shouldAutoScroll = true;
                this.userScrolledUp = false;
            } else if (container.scrollTop > 0) {
                this.shouldAutoScroll = false;
                this.userScrolledUp = true;
            }
            
            if (scrollBottom === 0) {
                this.shouldAutoScroll = true;
                this.userScrolledUp = false;
            }
        }
        
        scrollToBottom() {
            if (this.shouldAutoScroll) {
                this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
            }
        }
        // ========== –ö–û–ù–ï–¶: –ü–†–û–ö–†–£–¢–ö–ê ==========
        
        // ========== –ù–ê–ß–ê–õ–û: –ê–£–î–ò–û –§–£–ù–ö–¶–ò–ò ==========
        async toggleAudioRecording() {
            if (this.isRecording) {
                this.stopAudioRecording();
                return;
            }
            
            try {
                        // –°–û–•–†–ê–ù–ò –¶–ò–¢–ê–¢–£ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –∑–∞–ø–∏—Å–∏
        this.saveCurrentQuoteState();
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: { 
                        echoCancellation: true, 
                        noiseSuppression: true, 
                        autoGainControl: true 
                    } 
                });
                this.startAudioRecording(stream);
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:", error);
                this.showAudioError(error);
            }
        }
        
        startAudioRecording(stream) {
            console.log("=== –ù–ê–ß–ê–õ–û –ó–ê–ü–ò–°–ò –ê–£–î–ò–û ===");
            
            try {
                this.isRecording = true;
                this.audioChunks = [];
                this.recordingStartTime = Date.now();
                
                // –°–æ–∑–¥–∞–µ–º MediaRecorder
                const options = { mimeType: 'audio/webm' };
                this.mediaRecorder = new MediaRecorder(stream, options);
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–∞–Ω–Ω—ã—Ö
                this.mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        this.audioChunks.push(event.data);
                    }
                };
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
                this.mediaRecorder.onstop = () => {
                    if (this.audioChunks.length > 0) {
                        this.currentAudioBlob = new Blob(this.audioChunks, { 
                            type: 'audio/webm' 
                        });
                        
                        // –û—á–∏—Å—Ç–∫–∞
                        this.cleanupRecording();
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
                        this.showAudioPreview();
                    } else {
                        console.error("‚ùå –ù–µ—Ç –∞—É–¥–∏–æ –¥–∞–Ω–Ω—ã—Ö!");
                        this.handleRecordingError("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å –∞—É–¥–∏–æ");
                    }
                };
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–ø–∏—Å—å
                this.mediaRecorder.start(100);
                
                // UI –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                const audioBtn = document.getElementById('audioRecordBtn');
                if (audioBtn) audioBtn.classList.add('recording');
                
                document.getElementById('audioRecordingOverlay').style.display = 'flex';
                
                // –¢–∞–π–º–µ—Ä
                this.startRecordingTimer();
                
                // –í–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä
                this.startAudioVisualizer(stream);
                
                console.log("‚úÖ –ó–∞–ø–∏—Å—å –Ω–∞—á–∞—Ç–∞");
                
            } catch (error) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –Ω–∞—á–∞–ª–∞ –∑–∞–ø–∏—Å–∏:", error);
                this.isRecording = false;
                this.showAudioError(error);
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Ç–æ–∫
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
            }
        }
        
        startRecordingTimer() {
            const timerElement = document.getElementById('recordingTimer');
            const stopButton = document.getElementById('stopRecordingBtn');
            
            this.recordingTimer = setInterval(() => {
                const elapsed = Date.now() - this.recordingStartTime;
                const seconds = Math.floor(elapsed / 1000);
                const remaining = 60 - seconds;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º–µ—Ä
                if (timerElement) {
                    const mins = Math.floor(seconds / 60);
                    const secs = seconds % 60;
                    timerElement.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
                if (stopButton) {
                    stopButton.textContent = `‚èπÔ∏è –ó–∞–≤–µ—Ä—à–∏—Ç—å (${remaining})`;
                }
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —á–µ—Ä–µ–∑ 60 —Å–µ–∫—É–Ω–¥
                if (elapsed >= this.maxRecordingTime) {
                    this.stopAudioRecording();
                }
                
            }, 1000);
        }
        
        startAudioVisualizer(stream) {
            try {
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                this.analyser = this.audioContext.createAnalyser();
                const source = this.audioContext.createMediaStreamSource(stream);
                
                source.connect(this.analyser);
                this.analyser.fftSize = 256;
                
                const bufferLength = this.analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                const visualizer = document.getElementById('audioVisualizer');
                
                if (visualizer) {
                    visualizer.innerHTML = '';
                    for (let i = 0; i < 32; i++) {
                        const bar = document.createElement('div');
                        bar.className = 'visualizer-bar';
                        bar.style.height = '5px';
                        visualizer.appendChild(bar);
                    }
                    
                    this.visualizerInterval = setInterval(() => {
                        if (!this.isRecording) return;
                        
                        this.analyser.getByteFrequencyData(dataArray);
                        const bars = visualizer.querySelectorAll('.visualizer-bar');
                        
                        bars.forEach((bar, i) => {
                            const value = dataArray[i * 2] || 0;
                            const height = 5 + (value / 255) * 95;
                            bar.style.height = `${height}px`;
                            bar.style.opacity = 0.5 + (value / 255) * 0.5;
                        });
                    }, 100);
                }
            } catch (error) {
                console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä:", error);
            }
        }
        
        stopAudioRecording() {
            if (!this.isRecording || !this.mediaRecorder) return;
            
            console.log("=== –û–°–¢–ê–ù–û–í–ö–ê –ó–ê–ü–ò–°–ò ===");
            
            this.isRecording = false;
            clearInterval(this.recordingTimer);
            clearInterval(this.visualizerInterval);
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º MediaRecorder
            if (this.mediaRecorder.state === 'recording') {
                this.mediaRecorder.stop();
            }
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Ç–æ–∫
            if (this.mediaRecorder.stream) {
                this.mediaRecorder.stream.getTracks().forEach(track => {
                    track.stop();
                    track.enabled = false;
                });
            }
            
            // UI –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            const audioBtn = document.getElementById('audioRecordBtn');
            if (audioBtn) audioBtn.classList.remove('recording');
            
            document.getElementById('audioRecordingOverlay').style.display = 'none';
        }
        
        cancelAudioRecording() {
            if (!this.isRecording) return;
            
            this.isRecording = false;
            clearInterval(this.recordingTimer);
            clearInterval(this.visualizerInterval);
            
            if (this.mediaRecorder && this.mediaRecorder.state !== 'inactive') {
                this.mediaRecorder.stop();
                this.pendingQuote = null; // –û—á–∏—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —Ü–∏—Ç–∞—Ç—É –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ
            }
            
            if (this.mediaRecorder && this.mediaRecorder.stream) {
                this.mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
            
            this.audioChunks = [];
            this.currentAudioBlob = null;
            
            const audioBtn = document.getElementById('audioRecordBtn');
            if (audioBtn) audioBtn.classList.remove('recording');
            document.getElementById('audioRecordingOverlay').style.display = 'none';
        }
        
        cleanupRecording() {
            clearInterval(this.recordingTimer);
            clearInterval(this.visualizerInterval);
            
            if (this.audioContext) {
                this.audioContext.close();
                this.audioContext = null;
            }
            
            this.analyser = null;
            this.mediaRecorder = null;
        }
        
        showAudioPreview() {
            if (!this.currentAudioBlob) return;
            
            const audioURL = URL.createObjectURL(this.currentAudioBlob);
            const audioPlayer = document.getElementById('audioPreviewPlayer');
            
            if (audioPlayer) {
                audioPlayer.src = audioURL;
                
                audioPlayer.onloadedmetadata = () => {
                    const duration = audioPlayer.duration;
                    
                    if (isNaN(duration) || duration === Infinity) {
                        document.getElementById('audioLength').textContent = `–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞`;
                        document.getElementById('audioDuration').textContent = "0:00";
                    } else {
                        const roundedDuration = Math.floor(duration);
                        document.getElementById('audioLength').textContent = `${roundedDuration} —Å–µ–∫`;
                        document.getElementById('audioDuration').textContent = this.formatTime(roundedDuration);
                    }
                };
                
                audioPlayer.onerror = () => {
                    document.getElementById('audioLength').textContent = `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏`;
                    document.getElementById('audioDuration').textContent = "0:00";
                };
            }
            
            const sizeKB = Math.round(this.currentAudioBlob.size / 1024);
            document.getElementById('audioSize').textContent = `${sizeKB} KB`;
            document.getElementById('audioPreviewOverlay').style.display = 'flex';
        }
        
        deleteAudioPreview() {
            if (this.currentAudioBlob) {
                const audioPlayer = document.getElementById('audioPreviewPlayer');
                if (audioPlayer && audioPlayer.src) {
                    URL.revokeObjectURL(audioPlayer.src);
                    audioPlayer.src = '';
                }
            }
            
            this.currentAudioBlob = null;
            document.getElementById('audioPreviewOverlay').style.display = 'none';
            this.messageInput.focus();
            this.pendingQuote = null; // –û—á–∏—â–∞–µ–º –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—Ä–µ–≤—å—é
        }
        
async sendAudioMessage() {
console.log("üîç DEBUG sendAudioMessage:");
console.log("1. currentAudioBlob —Å—É—â–µ—Å—Ç–≤—É–µ—Ç?", !!this.currentAudioBlob);
console.log("2. –†–∞–∑–º–µ—Ä Blob:", this.currentAudioBlob?.size);
console.log("3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:", this.user?.uid);
console.log("4. Room ID:", this.roomId);
console.log("5. –ú–µ—Ç–æ–¥ blobToBase64 —Å—É—â–µ—Å—Ç–≤—É–µ—Ç?", typeof this.blobToBase64 === 'function');
    console.log("=== –û–¢–ü–†–ê–í–ö–ê –ê–£–î–ò–û–°–û–û–ë–©–ï–ù–ò–Ø (Base64) ===");
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∏
    if (!this.currentAudioBlob) {
        showStatus("‚ùå –ù–µ—Ç –∞—É–¥–∏–æ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏", "error");
        return;
    }
    
    if (!this.user) {
        showStatus("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω", "error");
        return;
    }
    
    if (this.currentAudioBlob.size === 0) {
        showStatus("‚ùå –ê—É–¥–∏–æ—Ñ–∞–π–ª –ø—É—Å—Ç–æ–π", "error");
        return;
    }
    
    // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
    const sendAudioBtn = document.getElementById('sendAudioBtn');
    const deleteAudioBtn = document.getElementById('deleteAudioBtn');
    
    if (sendAudioBtn) {
        sendAudioBtn.innerHTML = "‚è≥ –ö–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ...";
        sendAudioBtn.disabled = true;
    }
    if (deleteAudioBtn) {
        deleteAudioBtn.disabled = true;
    }
    
    try {
        showStatus("üì§ –ö–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—É–¥–∏–æ...", "info");
        
        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Blob –≤ Base64
        const base64String = await this.blobToBase64(this.currentAudioBlob);
        
        // –ü–æ–ª—É—á–∞–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
        const audioPlayer = document.getElementById('audioPreviewPlayer');
        let audioDuration = "0:00";
        if (audioPlayer && !isNaN(audioPlayer.duration)) {
            audioDuration = this.formatTime(Math.floor(audioPlayer.duration));
        }
        
        const sizeKB = Math.round(this.currentAudioBlob.size / 1024);
        
        // –°–æ–∑–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        const messageData = {
            type: 'audio',
            audioData: base64String, // Base64 —Å—Ç—Ä–æ–∫–∞
            audioFormat: 'webm',
            audioDuration: audioDuration,
            audioSize: sizeKB,
            userId: this.user.uid,
            userName: this.user.displayName || '–≠–ª–µ–∫—Ç—Ä–∏–∫',
            userEmail: this.user.email,
            userPhoto: this.user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(this.user.displayName || 'E')}&background=2c5364&color=fff`,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            isElectrician: true
        };
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –µ—Å–ª–∏ –µ—Å—Ç—å
        const textInput = document.getElementById('messageInput');
        if (textInput && textInput.value.trim()) {
            messageData.text = textInput.value.trim();
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ü–∏—Ç–∞—Ç—É –µ—Å–ª–∏ –µ—Å—Ç—å
let quoteData = null;

const quotePreview = document.getElementById('quotePreview');
if (quotePreview && quotePreview.style.display === 'block') {
    // –¶–∏—Ç–∞—Ç–∞ –∏–∑ –≤–∏–¥–∏–º–æ–≥–æ –ø—Ä–µ–≤—å—é
    const quoteId = quotePreview.getAttribute('data-quote-id');
    const quoteAuthor = quotePreview.getAttribute('data-quote-author');
    const quoteText = quotePreview.getAttribute('data-quote-text');
    
    if (quoteId && quoteAuthor && quoteText) {
        quoteData = {
            messageId: quoteId,
            author: quoteAuthor,
            text: quoteText
        };
    }
} else if (this.pendingQuote) {
    // –¶–∏—Ç–∞—Ç–∞ –∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è (–∫–æ–≥–¥–∞ –∑–∞–ø–∏—Å—ã–≤–∞–ª–∏ –∞—É–¥–∏–æ)
    quoteData = {
        messageId: this.pendingQuote.id,
        author: this.pendingQuote.author,
        text: this.pendingQuote.text
    };
    console.log("üîÑ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —Ü–∏—Ç–∞—Ç—É:", quoteData);
    
    // –û—á–∏—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —Ü–∏—Ç–∞—Ç—É –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    this.pendingQuote = null;
}

if (quoteData) {
    messageData.replyTo = quoteData;
}
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firestore
        showStatus("üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ —á–∞—Ç...", "info");
        await firebase.firestore()
            .collection('rooms')
            .doc('brotherhood-electricians-chr')
            .collection('messages')
            .add(messageData);
        
        // –£—Å–ø–µ—Ö
        showStatus("‚úÖ –ê—É–¥–∏–æ—Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!", "success");
        
        // –û—á–∏—â–∞–µ–º
        this.deleteAudioPreview();
        
        if (textInput) textInput.value = '';
        this.cancelQuote();
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
        if (sendAudioBtn) {
            sendAudioBtn.innerHTML = "‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å";
            sendAudioBtn.disabled = false;
        }
        if (deleteAudioBtn) {
            deleteAudioBtn.disabled = false;
        }
        
    } catch (error) {
        console.error("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞—É–¥–∏–æ:", error);
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
        if (sendAudioBtn) {
            sendAudioBtn.innerHTML = "‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å";
            sendAudioBtn.disabled = false;
        }
        if (deleteAudioBtn) {
            deleteAudioBtn.disabled = false;
        }
        
        let errorMessage = "–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ";
        if (error.code === 'permission-denied') {
            errorMessage = "‚ùå –ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏—è";
        } else if (error.code === 'resource-exhausted') {
            errorMessage = "‚ùå –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç —Ä–∞–∑–º–µ—Ä–∞. –ó–∞–ø–∏—Å—å —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–∞—è.";
        } else {
            errorMessage += error.message;
        }
        
        showStatus(errorMessage, "error");
    }
}


        
        formatTime(seconds) {
            if (isNaN(seconds) || seconds === Infinity || seconds < 0) {
                return "0:00";
            }
            
            if (seconds > 5999) {
                return "99:59+";
            }
            
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        showAudioError(error) {
            console.error("–û—à–∏–±–∫–∞ –∞—É–¥–∏–æ:", error);
            
            let message = "–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –∞—É–¥–∏–æ: ";
            
            switch (error.name) {
                case 'NotAllowedError':
                    message = "‚ùå –î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–ø—Ä–µ—â–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.";
                    break;
                case 'NotFoundError':
                    message = "‚ùå –ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω –∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.";
                    break;
                case 'NotReadableError':
                    message = "‚ùå –ú–∏–∫—Ä–æ—Ñ–æ–Ω –∑–∞–Ω—è—Ç –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º. –ó–∞–∫—Ä–æ–π—Ç–µ –¥—Ä—É–≥–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.";
                    break;
                default:
                    message += error.message || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞";
            }
            
            showStatus(message, "error");
            
            const recordBtn = document.getElementById('audioRecordBtn');
            if (recordBtn) {
                recordBtn.classList.remove('recording');
            }
        }
        
        handleRecordingError(message) {
            this.cleanupRecording();
            alert("‚ùå " + message + "\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.");
            this.currentAudioBlob = null;
            this.audioChunks = [];
        }



    // ‚Üì‚Üì‚Üì –í–°–¢–ê–í–¨ –≠–¢–û–¢ –ú–ï–¢–û–î –ü–†–Ø–ú–û –ó–î–ï–°–¨:
    saveCurrentQuoteState() {
        const quotePreview = document.getElementById('quotePreview');
        if (!quotePreview) return;
        
        // –ï—Å–ª–∏ –µ—Å—Ç—å –≤–∏–¥–∏–º–∞—è —Ü–∏—Ç–∞—Ç–∞, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ—ë –¥–∞–Ω–Ω—ã–µ
        if (quotePreview.style.display === 'block') {
            this.pendingQuote = {
                id: quotePreview.getAttribute('data-quote-id'),
                author: quotePreview.getAttribute('data-quote-author'),
                text: quotePreview.getAttribute('data-quote-text')
            };
            console.log("üíæ –¶–∏—Ç–∞—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞:", this.pendingQuote);
        } else {
            this.pendingQuote = null;
        }

        
        
        // –î–æ–±–∞–≤—å—Ç–µ —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –≤ –∫–ª–∞—Å—Å (–ø–æ—Å–ª–µ sendAudioMessage):
blobToBase64(blob) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => {
            // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ base64 —á–∞—Å—Ç—å (–±–µ–∑ data:audio/webm;base64,)
            const base64 = reader.result.split(',')[1];
            resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(blob);
    });
}
        // ========== –ö–û–ù–ï–¶: –ê–£–î–ò–û –§–£–ù–ö–¶–ò–ò ==========
    }

    // ========== –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ==========
    window.addEventListener('load', async function() {
        console.log("üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º...");
        
        try {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Firebase
            const app = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            storage = firebase.storage();
            
            console.log("‚úÖ Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
            
            // –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä —á–∞—Ç–∞
            chat = new ElectricianChat();
            
            console.log("‚úÖ –ß–∞—Ç –≠–ª–µ–∫—Ç—Ä–æ—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –°–æ–æ–±—â–µ—Å—Ç–≤–æ ¬´Electric Group –∑–∞–≥—Ä—É–∂–µ–Ω!");
            showStatus("–ß–∞—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!", "success");
            
        } catch (error) {
            console.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —á–∞—Ç:", error);
            showStatus("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–∞: " + error.message, "error");
        }
    });

    // –¢–µ—Å—Ç–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è
    window.testQuoteFunction = function() {
        const quotePreview = document.getElementById('quotePreview');
        if (quotePreview) {
            quotePreview.style.display = 'block';
            quotePreview.setAttribute('data-quote-id', 'test-id-123');
            quotePreview.setAttribute('data-quote-author', '–¢–µ—Å—Ç–æ–≤—ã–π –∞–≤—Ç–æ—Ä');
            quotePreview.setAttribute('data-quote-text', '–¢–µ—Å—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç —Ü–∏—Ç–∞—Ç—ã');
            
            document.getElementById('quoteAuthor').textContent = '–¢–µ—Å—Ç–æ–≤—ã–π –∞–≤—Ç–æ—Ä';
            document.getElementById('quoteText').textContent = '–¢–µ—Å—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç...';
        }
        
        const input = document.getElementById('messageInput');
        if (input) {
            input.value = '–≠—Ç–æ –º–æ–π –æ—Ç–≤–µ—Ç –Ω–∞ —Ü–∏—Ç–∞—Ç—É';
        }
    };
    </script>
</body>
</html>
